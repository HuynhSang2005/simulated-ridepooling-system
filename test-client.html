<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Ride Pooling Test Client</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <link rel="stylesheet" href="test-client.css" />
  </head>
  <body>
    <header>
      <h1 style="margin-top: 30px;">üöó Ride Pooling Test Client</h1>
      <p class="subtitle">Realtime WebSocket & API Simulator</p>
    </header>
    <div class="container" style="display: flex; gap: 20px;">
      <!-- PANEL ADMIN -->
      <div class="panel">
        <h2>PANEL ADMIN</h2>
        <input type="text" id="userIdForBooking" placeholder="D√°n userId ƒë·ªÉ t·∫°o booking...">
        <input type="text" id="pickupLat" placeholder="Pickup Lat (vd: 10.77)">
        <input type="text" id="pickupLng" placeholder="Pickup Lng (vd: 106.69)">
        <input type="text" id="dropoffLat" placeholder="Dropoff Lat (vd: 10.78)">
        <input type="text" id="dropoffLng" placeholder="Dropoff Lng (vd: 106.70)">
        <button onclick="createUser()">T·∫°o User M·ªõi</button>
        <button onclick="createDriver()">T·∫°o Driver M·ªõi</button>
        <button onclick="createBooking()">T·∫°o Booking</button>
        <button onclick="viewBookings()">Xem Danh s√°ch Bookings</button>
        <button onclick="viewDrivers()">Xem Danh s√°ch Drivers</button>
        <button onclick="fillSampleCoords()">ƒêi·ªÅn T·ªça ƒë·ªô M·∫´u</button>
        <button onclick="clearLogs()">X√≥a Logs</button>
        <div class="log-area">
          <h4>Logs H·ªá th·ªëng:</h4>
          <pre id="admin-logs">Ch∆∞a c√≥ log n√†o ƒë∆∞·ª£c ghi.</pre>
        </div>
      </div>
      <!-- PANEL DRIVER -->
      <div class="panel">
        <h2>PANEL T√ÄI X·∫æ</h2>
        <input type="text" id="driverId" placeholder="D√°n driverId v√†o ƒë√¢y...">
        <button onclick="connectAsDriver()">K·∫øt n·ªëi</button>
        <button onclick="startSendingLocation()">B·∫Øt ƒë·∫ßu g·ª≠i V·ªã tr√≠</button>
        <button onclick="stopSendingLocation()">D·ª´ng g·ª≠i V·ªã tr√≠</button>
        <button onclick="disconnectAll()">Ng·∫Øt t·∫•t c·∫£ k·∫øt n·ªëi</button>
        <div class="log-area">
          <h4>Th√¥ng tin L·ªô tr√¨nh:</h4>
          <pre id="route-info">Ch∆∞a c√≥ l·ªô tr√¨nh n√†o ƒë∆∞·ª£c g√°n.</pre>
        </div>
      </div>
      <!-- PANEL CUSTOMER -->
      <div class="panel customer-panel">
        <h2>PANEL KH√ÅCH H√ÄNG</h2>
        <input type="text" id="userId" placeholder="D√°n userId v√†o ƒë√¢y...">
        <button onclick="connectAsCustomer()">K·∫øt n·ªëi</button>
        <button onclick="viewPredictions()">Xem D·ª± ƒëo√°n Chuy·∫øn ƒëi</button>
        <div class="log-area customer-log">
          <h4>V·ªã tr√≠ T√†i x·∫ø:</h4>
          <pre id="driver-location">ƒêang ch·ªù th√¥ng tin...</pre>
        </div>
        <div class="prediction-area">
          <h4>Th√¥ng tin D·ª± ƒëo√°n:</h4>
          <pre id="prediction-info">Ch∆∞a c√≥ th√¥ng tin d·ª± ƒëo√°n.</pre>
        </div>
      </div>
    </div>
    <script>
      const API_BASE_URL = 'http://localhost:3000';
      let driverSocket, customerSocket, locationInterval;

      // --- Log Functions ---
      const adminLogs = document.getElementById('admin-logs');
      const routeInfo = document.getElementById('route-info');
      const driverLocation = document.getElementById('driver-location');
      const predictionInfo = document.getElementById('prediction-info');
      const logTo = (el, message) => {
        el.innerHTML = `${new Date().toLocaleTimeString()}: ${message}\n` + el.innerHTML;
      };

      // --- ADMIN FUNCTIONS ---
      async function createUser() {
        const name = `User ${Math.floor(Math.random() * 1000)}`;
        const email = `user${Math.floor(Math.random() * 1000)}@test.com`;
        const res = await fetch(`${API_BASE_URL}/users`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email })
        });
        const data = await res.json();
        logTo(adminLogs, `ƒê√£ t·∫°o User: ${data.name} (ID: ${data.id})`);
      }

      async function createDriver() {
        const name = `Driver ${Math.floor(Math.random() * 1000)}`;
        const res = await fetch(`${API_BASE_URL}/drivers`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });
        const data = await res.json();
        logTo(adminLogs, `ƒê√£ t·∫°o Driver: ${data.name} (ID: ${data.id})`);
      }

      async function createBooking() {
        const userId = document.getElementById('userIdForBooking').value;
        const pickupLat = parseFloat(document.getElementById('pickupLat').value);
        const pickupLng = parseFloat(document.getElementById('pickupLng').value);
        const dropoffLat = parseFloat(document.getElementById('dropoffLat').value);
        const dropoffLng = parseFloat(document.getElementById('dropoffLng').value);

        if (!userId || isNaN(pickupLat) || isNaN(pickupLng) || isNaN(dropoffLat) || isNaN(dropoffLng)) {
          alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß userId v√† t·ªça ƒë·ªô!');
          return;
        }

        const res = await fetch(`${API_BASE_URL}/bookings`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId,
            pickupAddress: "123 Random Street",
            pickupLocation: { lat: pickupLat, lng: pickupLng },
            dropoffAddress: "456 Destination Ave",
            dropoffLocation: { lat: dropoffLat, lng: dropoffLng }
          })
        });
        const data = await res.json();
        logTo(adminLogs, `Booking ${data.id} t·ª´ (${pickupLat},${pickupLng}) ƒë·∫øn (${dropoffLat},${dropoffLng}) ƒë∆∞·ª£c t·∫°o.`);
      }

      async function viewBookings() {
        const res = await fetch(`${API_BASE_URL}/bookings`);
        const bookings = await res.json();
        let html = 'DANH S√ÅCH BOOKINGS:\n';
        bookings.forEach(booking => {
          html += `- ID: ${booking.id.slice(-4)} | Status: ${booking.status} | User: ${booking.userId.slice(-4)}\n`;
        });
        logTo(adminLogs, html);
      }

      async function viewDrivers() {
        const res = await fetch(`${API_BASE_URL}/drivers`);
        const drivers = await res.json();
        let html = 'DANH S√ÅCH DRIVERS:\n';
        drivers.forEach(driver => {
          html += `- ID: ${driver.id.slice(-4)} | Name: ${driver.name} | Status: ${driver.status}\n`;
        });
        logTo(adminLogs, html);
      }

      // --- DRIVER FUNCTIONS ---
      function connectAsDriver() {
        const driverId = document.getElementById('driverId').value;
        if (!driverId) { 
          alert('Vui l√≤ng nh·∫≠p driverId'); 
          return; 
        }
        
        if (driverSocket) driverSocket.disconnect();

        driverSocket = io(API_BASE_URL, { 
          query: { driverId: driverId } 
        });
        
        logTo(routeInfo, `ƒêang k·∫øt n·ªëi v·ªõi t∆∞ c√°ch t√†i x·∫ø ${driverId}...`);

        driverSocket.on('connect', () => {
          logTo(routeInfo, 'K·∫øt n·ªëi th√†nh c√¥ng! ƒêang ch·ªù l·ªô tr√¨nh...');
        });
        
        driverSocket.on('disconnect', () => {
          logTo(routeInfo, 'ƒê√£ ng·∫Øt k·∫øt n·ªëi.');
        });
        
        driverSocket.on('new_route', (route) => {
          logTo(routeInfo, 'üéâ C√ì L·ªò TR√åNH M·ªöI! üéâ');
          displayRoute(route);
        });
      }

      function displayRoute(route) {
        let html = `L·ªô tr√¨nh ID: ${route.id}\nT·ªïng th·ªùi gian: ${Math.round(route.totalDuration / 60)} ph√∫t\n\nƒêi·ªÉm d·ª´ng:\n`;
        route.stops.forEach(stop => {
          html += `  - Seq ${stop.sequence}: ${stop.type} ${stop.bookingId ? `(Booking: ...${stop.bookingId.slice(-4)})` : ''}`;
          // Th√™m button cho c·∫£ PICKUP v√† DROPOFF
          if (stop.type === 'PICKUP' || stop.type === 'DROPOFF') {
            html += ` <button onclick="completeStop('${stop.id}')">Ho√†n th√†nh</button>`;
          }
          html += `\n`;
        });
        routeInfo.innerHTML = html;
      }

      async function completeStop(stopId) {
        await fetch(`${API_BASE_URL}/stops/${stopId}/complete`, { method: 'PATCH' });
        logTo(routeInfo, `ƒê√£ g·ª≠i y√™u c·∫ßu ho√†n th√†nh stop ${stopId}`);
      }

      function startSendingLocation() {
        if (!driverSocket || !driverSocket.connected) { alert('T√†i x·∫ø ch∆∞a k·∫øt n·ªëi!'); return; }
        stopSendingLocation(); // D·ª´ng interval c≈© n·∫øu c√≥
        logTo(routeInfo, 'B·∫Øt ƒë·∫ßu g·ª≠i v·ªã tr√≠ m√¥ ph·ªèng m·ªói 5 gi√¢y...');
        locationInterval = setInterval(() => {
          const location = { lat: 10.75 + Math.random() * 0.1, lng: 106.65 + Math.random() * 0.1 };
          driverSocket.emit('update_location', location);
          logTo(routeInfo, `ƒê√£ g·ª≠i v·ªã tr√≠ m·ªõi: ${JSON.stringify(location)}`);
        }, 5000);
      }

      function stopSendingLocation() {
        clearInterval(locationInterval);
        logTo(routeInfo, 'ƒê√£ d·ª´ng g·ª≠i v·ªã tr√≠.');
      }

      // --- CUSTOMER FUNCTIONS ---
      function connectAsCustomer() {
        const userId = document.getElementById('userId').value;
        if (!userId) { 
          alert('Vui l√≤ng nh·∫≠p userId'); 
          return; 
        }
        
        if (customerSocket) customerSocket.disconnect();

        // Ch·ªâ truy·ªÅn userId, kh√¥ng truy·ªÅn driverId
        customerSocket = io(API_BASE_URL, { 
          query: { userId: userId } // Kh√¥ng c√≥ driverId ·ªü ƒë√¢y
        });
        
        customerSocket.on('connect', () => logTo(driverLocation, `K·∫øt n·ªëi th√†nh c√¥ng v·ªõi t√†i x·∫ø qua userId ${userId}`));
        customerSocket.on('disconnect', () => logTo(driverLocation, 'ƒê√£ ng·∫Øt k·∫øt n·ªëi.'));
        customerSocket.on('driver_location_updated', (location) => {
          logTo(driverLocation, `üìç V·ªã tr√≠ t√†i x·∫ø: ${JSON.stringify(location)}`);
        });
      }

      function clearLogs() {
        adminLogs.innerHTML = 'Logs ƒë√£ ƒë∆∞·ª£c x√≥a.';
        routeInfo.innerHTML = 'Ch∆∞a c√≥ l·ªô tr√¨nh n√†o ƒë∆∞·ª£c g√°n.';
        driverLocation.innerHTML = 'ƒêang ch·ªù th√¥ng tin...';
        predictionInfo.innerHTML = 'Ch∆∞a c√≥ th√¥ng tin d·ª± ƒëo√°n.';
      }

      function disconnectAll() {
        if (driverSocket) {
          driverSocket.disconnect();
          logTo(routeInfo, 'Driver ƒë√£ ng·∫Øt k·∫øt n·ªëi.');
        }
        if (customerSocket) {
          customerSocket.disconnect();
          logTo(driverLocation, 'Customer ƒë√£ ng·∫Øt k·∫øt n·ªëi.');
        }
        stopSendingLocation();
      }

      function fillSampleCoords() {
        document.getElementById('pickupLat').value = '10.7769';
        document.getElementById('pickupLng').value = '106.7009';
        document.getElementById('dropoffLat').value = '10.7829';
        document.getElementById('dropoffLng').value = '106.6958';
        logTo(adminLogs, 'ƒê√£ ƒëi·ªÅn t·ªça ƒë·ªô m·∫´u TP.HCM (Qu·∫≠n 1 ‚Üí Qu·∫≠n 3)');
      }

      async function viewPredictions() {
        const userId = document.getElementById('userId').value;
        if (!userId) {
          alert('Vui l√≤ng nh·∫≠p userId');
          return;
        }

        try {
          // L·∫•y active booking c·ªßa user
          const userRes = await fetch(`${API_BASE_URL}/users/${userId}/active-booking`);
          const activeBooking = await userRes.json();
          
          // L·∫•y predictions cho booking ƒë√≥
          const predRes = await fetch(`${API_BASE_URL}/bookings/${activeBooking.id}/predictions`);
          const predictions = await predRes.json();
          
          let html = `TH√îNG TIN D·ª∞ ƒêO√ÅN:\n`;
          html += `üìç T·ª´: ${activeBooking.pickupAddress}\n`;
          html += `üéØ ƒê·∫øn: ${activeBooking.dropoffAddress}\n`;
          html += `‚è∞ T√†i x·∫ø ƒë·∫øn ƒë√≥n: ${predictions.estimatedPickupTime}\n`;
          html += `üïê Th·ªùi gian di chuy·ªÉn: ${predictions.estimatedTripDuration}\n`;
          html += `üë®‚Äç‚úàÔ∏è T√†i x·∫ø: ${predictions.driver?.name || 'Ch∆∞a g√°n'}\n`;
          html += `üìä Tr·∫°ng th√°i: ${predictions.status}\n`;
          
          document.getElementById('prediction-info').innerHTML = html;
          
        } catch (error) {
          logTo(driverLocation, `L·ªói: ${error.message}`);
        }
      }
    </script>
  </body>
</html>